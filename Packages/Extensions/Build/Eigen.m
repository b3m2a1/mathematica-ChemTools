(* ::Package:: *)

(* Autogenerated Package *)

$EigenDirectory::usage="The directory eigen3 is built into";
EigenCheck::usage="Checks that eigen3 is installed";
EigenBuild::usage="Gets the eigen3 system";


Begin["`Private`"];


(* ::Subsubsection::Closed:: *)
(*FindEigen*)



$EigenPath=
	{
		$ChemExtensionsDev,
		$ChemExtensionsApp
		};


FindEigen[]:=
	Replace[
		StringTrim@
			RunProcess[			
				{If[$OperatingSystem=="Windows","where", "which"], "eigen3"},
				"StandardOutput"
				],
		{
			ob_String?(StringLength[#]>0&&FileExistsQ[#]&&
				eigenDirQ[Nest[DirectoryName, #, 2]]&):>
				Nest[DirectoryName, ob, 2],
			_:>
				SelectFirst[
					FileNames["*eigen*", $EigenPath],
					eigenDirQ,
					ChemExtensionDir["eigen3"]
					]
			}
		]


(* ::Subsubsection::Closed:: *)
(*$EigenDirectory*)



$EigenDirectory:=
	$EigenDirectory=FindEigen[];


(* ::Subsubsection::Closed:: *)
(*eigenCheck*)



eigenDirQ[dir_]:=
	FileExistsQ@FileNameJoin@{dir, "Eigen"}


eigenCheck[dir_]:=
	eigenDirQ@FileNameJoin@{dir, "eigen3"}


(* ::Subsubsection::Closed:: *)
(*EigenCheck*)



EigenCheck//Clear


EigenCheck[dir_:Automatic]:=
	eigenCheck@
		Replace[dir, Automatic:>DirectoryName@$EigenDirectory]


(* ::Subsubsection::Closed:: *)
(*$eigen3src*)



$eigen3src="http://bitbucket.org/eigen/eigen/get/3.2.10.zip";


(* ::Subsubsection::Closed:: *)
(*eigenDownload*)



eigenDownload[dir_String?DirectoryQ]:=
		With[{
			tmpDir=
				CreateDirectory@
					FileNameJoin@{
						$TemporaryDirectory,
						StringJoin@RandomSample[Alphabet[],10]
						}
			},
			Monitor[
				With[
					{
						f=URLDownload[$eigen3src,FileNameJoin@{tmpDir,"eigen3_tmp.zip"}],
						out=FileNameJoin@{dir, "eigen3"}
						},
					ExtractArchive[f, tmpDir];
					DeleteFile[f];
					If[DirectoryQ@out, DeleteDirectory[out, DeleteContents->True]];
					CopyDirectory[First@FileNames["*",tmpDir], out];
					Quiet@DeleteDirectory[tmpDir,DeleteContents->True];
					Replace[
						out,
						Except[_String?FileExistsQ]:>
							PackageRaiseException[
								"EigenBuild",
								"Eigen3 failed to download to ``",
								"MessageParameters"->{out}
								]
						]
				],
			Internal`LoadingPanel["Downloading eigen3"]
			]
		];


(* ::Subsubsection::Closed:: *)
(*EigenBuild*)



EigenBuild[d:(_String?DirectoryQ|Automatic):Automatic]:=
	PackageExceptionBlock["EigenBuild"]@
		Which[
			eigenDirQ@Replace[d, Automatic:>$EigenDirectory],
				Replace[d, Automatic:>$EigenDirectory],
			EigenCheck@d,
				FileNameJoin@{
					Replace[d, Automatic:>ParentDirectory@$EigenDirectory],
					"eigen3"
					},
			True,
				eigenDownload[Replace[d,Automatic:>DirectoryName@$EigenDirectory]]
			];


End[];



