(* ::Package:: *)

(************************************************************************)
(* This file was generated automatically by the Mathematica front end.  *)
(* It contains Initialization cells from a Notebook file, which         *)
(* typically will have the same name as this file except ending in      *)
(* ".nb" instead of ".m".                                               *)
(*                                                                      *)
(* This file is intended to be loaded into the Mathematica kernel using *)
(* the package loading commands Get or Needs.  Doing so is equivalent   *)
(* to using the Evaluate Initialization Cells menu command in the front *)
(* end.                                                                 *)
(*                                                                      *)
(* DO NOT EDIT THIS FILE.  This entire file is regenerated              *)
(* automatically each time the parent Notebook file is saved in the     *)
(* Mathematica front end.  Any changes you make to this file will be    *)
(* overwritten.                                                         *)
(************************************************************************)



$Psi4::usage=
	"The default Psi4 instance";
$Psi4Dir::usage=
	"Directory for the default Psi4 instance";


Psi4Build::usage=
	"Gets and compiles the Psi4 system if necessary";


Psi4::usage="A psi4 instance";
Psi4Input::usage="An association configuring a Psi4 run";
Psi4Output::usage="An association with Psi4 output";
Psi4Data::usage="An association of Psi4 data";


Psi4Call::usage="Basic Psi4 call on either an association or a file / directory";
$Psi4ConfigMap::usage="Maps options names to Psi4 names";
$Psi4ConfigChoices::usage="Helpful dict of option choices";
Psi4Compile::usage=
	"Overloads the private ToPython symbolic converter to create Psi4 ready structures";
Psi4Molecule::usage=
	"Turns atoms / positions into a molecule string for a Psi4 input file";
Psi4Config::usage=
	"Configures a 'set' block for a psi4 input file from option names";
Psi4Function::usage=
	"Configures a Psi4 function call";
Psi4GridFile::usage=
	"Configures a grid file string ready for psi4";
Psi4InputFile::usage=
	"Configures an input file string ready for psi4";
Psi4ConfigureCall::usage=
	"Preps an input file + other info ready for psi4";


Psi4UtilsAutoGrid::usage="";
Psi4UtilsAutoScan::usage="";
Psi4DataParseGeometry::usage="";


Psi4GeometryOptimize::usage="Basic geometry optimization";
Psi4GeometryInfo::usage="Gathers basic psi4 structural info";
Psi4Property::usage=
	"Formats a basic call to property";
Psi4Scan::usage=
	"Performs a function in a scan";


Psi4Energy::usage="";
Psi4EnergyScan::usage="";


Psi4OneElectronProperty::usage=
	"Calls oeprop. To be subclassed";
Psi4OneElectronElectrostaticPotential::usage=
	"Calls oeprop electrostatic potential";
Psi4OneElectronDipoleMoment::usage=
	"Gets oeprop dipole moments";


Psi4CubeProperty::usage=
	"Calls cubeprop to generate a cubefile for a given property";
Psi4CubeOrbitals::usage=
	"Generates orbitals with cubeprop";
Psi4CubeElectronDensity::usage=
	"Calculates electron density with cubeprop";
Psi4CubeElectrostaticPotential::usage=
	"Calculates electrostatic potential with cubeprop";


Begin["`Private`"];


PyToolsLoad[]


$Psi4Dir=ChemExtensionDir["psi4"];
$Psi4:=Psi4@$Psi4Dir;


psi4Download[parentDir_?DirectoryQ]:=
	terminalRun[{
		"git","clone","--recursive",
		"https://github.com/psi4/psi4.git",
		ExpandFileName@FileNameJoin@{parentDir,"psi4"}
		}];


Psi4Build::nodir="Directory `` not found";
psi4Build[parentDir_?DirectoryQ]:=
	If[DirectoryQ@FileNameJoin@{parentDir,"psi4"},
		AbsoluteTiming[{
		If[(!DirectoryQ@FileNameJoin@{parentDir,"psi4","objdir"})&&
				cmakeCheck@parentDir,
			terminalRun[{
				If[FileExistsQ@FileNameJoin@{parentDir,"cmake","bin","cmake"},
					ExpandFileName@FileNameJoin@{parentDir,"cmake","bin","cmake"},
					"cmake"
					],
				"-H.","-Bobjdir",
				"-DCMAKE_INSTALL_PREFIX="<>
					ExpandFileName@FileNameJoin@{parentDir,"psi4"}
				},
				ProcessEnvironment-><|
					"PATH"->
						StringJoin@{
							Environment["PATH"],
							":",
							Riffle[{
									ExpandFileName@FileNameJoin@{parentDir,"cmake","bin"},
									ExpandFileName@FileNameJoin@{parentDir,"psi4"}
									},
								":"
								]
							}
					|>,
				ProcessDirectory->ExpandFileName@FileNameJoin@{parentDir,"psi4"}
				]
			],
		If[!DirectoryQ@
				FileNameJoin@{
					parentDir,
					"psi4","objdir","stage",
					FileNameTake[ExpandFileName@parentDir,1]},
			terminalRun[{"make","-j`getconf _NPROCESSORS_ONLN`"},
				ProcessDirectory->ExpandFileName@FileNameJoin@{parentDir,"psi4","objdir"}
				];
			terminalRun[{"make","install"},
				ProcessDirectory->ExpandFileName@FileNameJoin@{parentDir,"psi4","objdir"}
				]
			],
		With[{psi4=
			ExpandFileName@
				FileNameJoin@{parentDir,"psi4","objdir","stage",
					ExpandFileName@parentDir,"psi4"
					}
				},
			If[DirectoryQ@psi4,
				If[!DirectoryQ@FileNameJoin@{parentDir,"psi4","dist"},
					CreateDirectory@FileNameJoin@{parentDir,"psi4","dist"}
					];
				CopyDirectory[
					psi4,
					FileNameJoin@{parentDir,"psi4","dist","psi4"}
					]
				]
			]
		}]//If[Last@Last@#=!=Null,
			TemplateApply["Built to `pkg`. Took `time`.",
					<|
						"time"->(
							$Psi4BuildLogs=Last@#;
							UnitConvert[Quantity[First@#,"Seconds"],"Minutes"]
							),
						"pkg"->Last@Last@#
						|>],
			$Failed
			]&,
		Message[Psi4Build::nodir,FileNameJoin@{parentDir,"psi4"}]
		];


Psi4Build[parentDir_?DirectoryQ]:=
	(
	If[!cmakeCheck@parentDir,
		cmakeBuild@parentDir
		];
	If[!FileExistsQ@FileNameJoin@{parentDir,"psi4"},
		psi4Download@parentDir
		];
	psi4Build@parentDir
	);
Psi4Build[Optional[Automatic,Automatic]]:=
	Psi4Build[DirectoryName[$Psi4Dir]];


psiBin[d_String]:=FileNameJoin@{d,"bin","psi4"}


psi4Q[d_String]:=
	FileExistsQ@psiBin@d;
psi4Q[_]:=
	False;


Psi4UtilsAutoGrid[
	atomset_List,
	{xpoints_Integer,ypoints_Integer,zpoints_Integer},
	mode:"Sphere"|"Grid":"Grid",
	props___?OptionQ
	]:=
	With[{cbs=ChemUtilsCoordinateBounds[atomset]},
		<|
			"Molecules"->atomset,
			"Grid"->
				Table[
					{x,y,z},
					{x,Replace[Subdivide[cbs[[1]],xpoints],{f_,l_}:>f,1]},
					{y,Replace[Subdivide[cbs[[2]],ypoints],{f_,l_}:>f,1]},
					{z,Replace[Subdivide[cbs[[3]],zpoints],{f_,l_}:>f,1]}
					],
			props
			|>	
		];
Psi4UtilsAutoGrid[
	atomset_List,
	atMostPoints:_Integer:27,
	mode:"Sphere"|"Grid":"Grid",
	props___?OptionQ
	]:=
	With[{
		xp=Floor@Power[atMostPoints,1/3],
		yp=Floor@Power[atMostPoints,1/3],
		zp=Floor@Power[atMostPoints,1/3]
		},
		Psi4UtilsAutoGrid[atomset,{xp,yp,zp},props]
		];


Psi4UtilsCoordinateScanGrid//Clear


Psi4UtilsCoordinateScanGrid[
	coordinateBounds_,
	divs:{Repeated[_->_,{3}]}
	]:=
	Map[
		Replace[divs[[#, 2]],{
			i_?NumericQ:>
				{
					divs[[#,1]],
					Sequence@@coordinateBounds[[#]],
					Apply[Subtract,Reverse[coordinateBounds[[#]]]]/i
					},
			{s_List}:>
				{divs[[#,1]],s},
			{s_,e_,i_}:>
				If[Abs[e-s]>0,
					{divs[[#,1]],{s}},
					{
						divs[[#,1]],
						s,
						e,
						(e-s)/i
						}
					]
			}]&,
		Range[3]
		]
Psi4UtilsCoordinateScanGrid[
	coordinateBounds_,
	divs:{_,_,_}
	]:=
	Psi4UtilsCoordinateScanGrid[
		coordinateBounds,
		Map[
			"pyVar_"<>ToString[#]->divs[[#]]&,
			Range[3]
			]
		]


Psi4UtilsCoordinateScanSphere//Clear


Psi4UtilsCoordinateScanSphere[
	coordinateBounds_,
	divs:{Repeated[_->_,{3}]}
	]:=
	With[{
		r=(Subtract@@Reverse@MinMax[Flatten@coordinateBounds])/2.
		},
		Map[
			Replace[divs[[#, 2]],{
				i_Integer:>
					{
						divs[[#,1]],
						Switch[#,
							1,
								Sequence@@{Min@{.00001,r/100}, r, r/i},
							2,
								Sequence@@{0, 360, 360/i},
							3,
								Sequence@@{0, 180, 180/i}
							]
						},
				{s_List}:>
					{divs[[#,1]],s},
				{s_,e_,i_}:>
					If[Abs[e-s]>0||i==0,
						{divs[[#,1]],{s}},
						{
							divs[[#,1]],
							If[!IntegerQ@s,N@s,s],
							If[!IntegerQ@e,N@e,e],
							If[!IntegerQ@#,N@#,#]&[(e-s)/i]
							}
						]
				}]&,
			Range[3]
			]
		];
Psi4UtilsCoordinateScanSphere[
	coordinateBounds_,
	divs:{_,_,_}
	]:=
	Psi4UtilsCoordinateScanSphere[
		coordinateBounds,
		Map["pyVar_"<>ToString[#]->divs[[#]]&,Range[3]]
		]


psi4ScanSpecBasePat=
	_?NumericQ|{_?NumericQ,_?NumericQ,_?NumericQ}|{_List}
psi4ScanSpecPat=
	psi4ScanSpecBasePat|
		(_->psi4ScanSpecBasePat)


Psi4UtilsAutoScan//Clear


Psi4UtilsAutoScan[
	atomset_List,
	pts:{Repeated[psi4ScanSpecPat,{3}]},
	mode:"Sphere"|"Cube":"Cube",
	props___?OptionQ
	]:=
	With[
		{
			cbs=
				ChemUtilsCoordinateBounds@
					DeleteCases[atomset,
						Except[{_,{__?NumericQ}}]
						]
			},
		<|
			props,
			"Molecules"->atomset,
			"Scan"->
				If[mode==="Sphere",
					Psi4UtilsCoordinateScanSphere[cbs,pts],
					Psi4UtilsCoordinateScanGrid[cbs,pts]
					],
			If[mode==="Sphere",
				"ScanCoordinatesPre"->
					With[{scanf=Lookup[{props},"ScanCoordinatesPre",Identity]},
						If[scanf===Identity,
							PyFromSphericalCoordinates[{#,#2,#3}],
							PyFromSphericalCoordinates@
								PyStar[PyCall[scanf][#,#2,#3]]
							]
						],
				Nothing
				]
			|>
		];
Psi4UtilsAutoScan[
	atomset_List,
	atMostPoints:_Integer:27,
	mode:"Sphere"|"Grid":"Grid",
	props___?OptionQ
	]:=
	With[{
		xp=Floor@Power[atMostPoints,1/3],
		yp=Floor@Power[atMostPoints,1/3],
		zp=Floor@Power[atMostPoints,1/3]
		},
		Psi4UtilsAutoScan[atomset,{xp,yp,zp},mode,props]
		];


$psi4RunIcon=Image[CompressedData["
1:eJztm+dX29fW5+96Zl48L+dfmDXPfXLvTdwSF8DGYAMGXAAbMNVUgwQCJIqQ
aJKoAiEJFYRAFIkqukQViCaahJBAoohqnNieJHaKkzjVDc8+woALNc6a9axZ
cwwuQb+PvmfvffbZe0P+Zwj+Rvi//e1vf4v/d/jtRjDpQlxccJL7/4B/eMbE
R2Biwm47xySEYcLiLEL+G/zH/w6fdq8/X+2x1p88XLyrwBOIU/dXn/y+1yt3
Xi+/neuramxp7+jo6urt7ejs1qz9eijAH/PKqua2tvbOLkVPr1LZ19c/NNTX
b3p4cAWmxqqWFll7V49S2T8wqEJraEg1PNo/8/WBAOsP+6sbGwGgUPbD4yOj
o2PjY2NjoyMjI8NjSs1PB5AwX9NY3yTv6O7ph+fHxtRqzYRGo1YDZnR0ZEwz
srwf4Zmytr6+pa2zp2/ADJiY0E5OahHEzBgdVQ9P/7HnJv53W520obWtS9E3
CASNRqvT63Q6gGwzxieMz/cgPCiR1jU0yzt7+ofACGrtpE6Plu4tHWO6xRe7
In4T19U1NDXL2rv7hobHxicmdVPT01NTU/o3dIwhxtLTXQhPldXVNXX1jTIw
xYBqdBx2MW00GLYYZpsiIWPaqZ0JL6fKJGJJVV2jvL27t181Mj6h0xuNMzMG
w/SUXm9mjG/q0N/fkbBcVF4qrqqtb5V39PQOQiSpJ6cMM7OzszNICjLIxl6Q
ELV2pyD7papCWCqprm+Wd0BYDg6PgO11BuPs3PzcjNEI29GbGWMbSzv+vlue
6YSFJeWSmvoWeadCCeYcGVeDT42zJtP8HBICu9Ft6QDGewfmqb6EV1Qqqapt
kG/E1TCElVar1RtnFxdNSMgWwwwZ15nW3yY81xXzeMXlkmopRMVGbCMRk1qt
zjBnZszOmBmTmg2jjo3p3rHGg5piTmFJBewDQrOnFwJrTK2F0AbG9MzC4uKC
aYsxsQEZn9S8FRx/NFRwACGurGsCjypRcKs1k5MotsEcpqUlYMy/ZmgnNoW8
aY11TUkBmycQiaukLXDI+9Dx0E7qp80xpZuaXVpeNjPM9gBhZoOMT715Zh8K
ilgcfpFIXN3Q2tHdC5Gp1uqmDEb0iE5vmFlaXdlmvA52tVo783IbMVjKYXIK
i0slNZAoFOh8TABiIzKn9AajaeUOMBbBHsBAMQYMgAz+sEX4rVJUwOQJissk
tU1y8/FQT0xOAWBmFjGmjLNLdzZ0zG2Yw3xyYS/bPlkqFDBYvCJQsYXQ6lFc
zs7NzZhWTEbj/CowwKbz2wzQoVvdQnSWcHLZ/KKSMklNsxkxjkRAXC7Mz999
/PuzxwuzS2vAQPFh3soGY2I7GT8vExbQCwABtmhE6UY1NjEJUTm3sLiw+NVP
z169+n5uaXVtdXV7Kxt70Wk2Ed+wChFCWFIKHkHmVI1qDGCHedOiaeHBj3+8
fPXirml17fVWNjwLDO2EVrGJeMQpZJoRZeLqelk7IMZmHjz6Ym5+cclo/Pzb
n/548cfn86trZhmLSAY6tcgvk72biGEuj5ljVlFRKW1pg+AcXvj6m0cr84Zp
jX7h3rc//vzDHXDrWzLMjG1ED4+bmwXBCRtBAd7V26+cuf+VHu4gzdT49MIX
X359f25+6c5ds2MXkVMMr+NWuYno5XDoGflcQbGoQlLbiFKWfHjhiyWDcW5x
yTCuM66AW01LyBjIKRsyzAzD55uICQ6XQcvlFIIxIGm1yLt75W0qw8Kccc60
sDQzNft4xWCcX1q5c+fOCoovdNwQQz85vZVAv2FyGLQsNscso65B1qZQyuV9
Y5B6500Li0sLPz0wGGcWV9EyI+Y2ZOi16q2j+jCHk0ej5XF4hZA7q6TmAB0a
1qAQRzpM3347bZhdWAbCnY0on91I6pqhXzYRL0q5eVRKNnODUS1tQRZVjSHG
rAnceP8JBPvC8vIK+nidOEDGpHpi+1JTcnOpRFpOPsd81FAO74ZLYGwCzsk8
2G/t11njjGkJIcy557UKzYRx+6zfy8+lEZIz6IwCjgCSeC0yad+Qalw7hZyy
uPZ0GbyzsLgMiEXzkTer0IysbCOeFTOo8XGp6fQ8sKkQLgJpK5h0cBgcCvqX
l3+/B6wFdGIgLObn5+Y2XKJ+s/gaZFETCIlptJw8NoRHBTrzXUqojHRzkChW
l558OzltnFlAkIV5EIGS6PT0zFv36o+8rEQcnpxGy6IzYS/otHX1qoZHpk13
7q6tzH/7RD9tvtZMcC0hBLogp00P3kS8GslPwmMJpFRaJmKIKqWgAuxpXLr7
+Z3Fmft/LM+CNSAFgQCzCHTS5t5GPG/NiQuPiE1MombkcrhCibS1q181oZtd
vgMiTN+8eP7dLGTjGXjenAthH3r99Mzb19l3xSm4kMhYIpmWnc/hl9bJFP3D
2um5xeWleeMXEEEvv5manjLAdiCrIw1QLOh6Xr6FeDHHTAgLwhIS0jJzC7ii
Oll3/4jWMGuan5me+vxHeLvfjXqEMIPQUddP6lVvI169nKXHBQdiCcmZ9AJB
GSAGRzV6UKwb1yx8/fvLVz8boGzSA0EPAITQTb2zEdAxzUq45YsjwWEpFiMV
KrgT1SNDfQOTyw9/fPKFZgLS1KQOqQAAShcj7yJerX/bRAzwxdMYfJG4pqVd
0T84OKhUdHYohrSm1SUtKkGBAJuBjaBzqhl6+S4C/DKRHeJFZhcWV1TWy9ra
2+Wy5kZUu/UOj0G1ATccSDAYjGaHaNSaxfcJIOTHHkxQGhMOrLiqpqZaIpFU
18LBbe9R9quG4XIBj6C6yzCl1YwN9c/shIDj0hocTkjLzGOyCjg8vlAEZU+j
HIrhHpUKLkktuqkNUzqNeniop+f7nREvP4+KiIwhxJFoGXD4C4vKK+taZJBO
zfesFipQ8NGEZkw12NOl3K2M/jUvGk+II5LT0nMYHF6xpKoG0kencnBoGF3V
Oj3UJ5rhoX5FR/vkew55vV4MEROI5EQylZ5vPnESCdpIX//gqHocdRUa9egQ
OEreInu0C+HV+nfpSeSkFCotO4/FLQYVUplcjvqCsdFxVB+NQIel6JY3NQzt
3g48a8ukUGjpmXR6PtwKNbX1zbIOuJzM/RE8DwoUbbL6mvodK+jXMr4vzsrM
ymEWwMUiLJHUNUMdCj3ewODg0OBAX4+iq03WJBVLOp/tjoDOipWXy8iHPAoq
KlFjIG/r6FYoehSwOmSyZmm1uKzqqz0IEKQqTn5+PptbiC5q6AykjU2tcsB0
mMNVWispL6la2JPw6tWTOn4+A+0EdIjKJZXQo0CjA6tJKq0GQHH54D4E6LRb
uYw8BovD4RUJzVIqq2ukUmltTaW4vETIFw3tZYjXjJ+b+GAPJovD5RYWCYtF
peUSsVhcUSYSCricku492rttxo8KHrIpi83hcHmIUlJSIiwq5BUUFAiMuzVm
76wXM5JCBGGyC2A/fD6Pxy1gM/MYwvbV/R/eFPJoRFzIzGMyWeyCAjabzcrP
pTMKa/SHmkKsP1I1F/O5eQwGPTs3N5ddVNymPUDH/s56+vmIQlxdxWKKqmr6
Zh/tdjb3FPLixfOffv5RN/ngya8vnu/eI+/6/E/3h4e51mfP1/SPfPPb4d//
5VdDgoigm9ddHe1tbKwsbN2pyseHAvyuLYmKwAYG+nq4XXF2sLW2PHPy0xOO
LOP+T75eL/T5sfExOFz47SBfH0/Xq072NucsTn92/NgpouFgW/hSmppCTEyM
J8RgIsL8fH1uuF1xtLO1tjh98sQxC8oBpjkvphjZNAolOSmRnIjH4yNCg/y9
b7hdc7K/YHPW4syp0+69+xGeyZn0zPTMjCwaJTU5OY4QGxMeFuLv7eHm6ux4
0dbayuLMRcGe3ll/UM9lMfMZuTk5WfTMjMxUcgo5LjoiLCTQx8v9uovTJXs7
m3OXsvYI8vX7/KICFosJ55GZR8/Myc2ipZKTkuII0Zgw2I+PB5j2kr395dzd
Gb+ViIoEfDYzH04WpwDE0PMYmenUVGJiXAwuIhSkeLu7ulxxdmfvNqx72lMm
hFPN4YAQFhfOeAHoYdJzGVlAiUsg4LDhgb4+3h7u171EOxNeTgmFfLQNDofP
hb1weDz4ewEkHjipdGpSfAyBEInBBPoHeHtjhnckLAuKOPAIQgh4AgGAIE0V
iYpADIMNB56WlkSKJeBx0djg0GDS0g6IX6qKWUxmAY/DL+RxucKyEgG0WpDB
K0RlIgGIYXHYORk0CikuHo+PxkRz3k9/Tye5DFiQLPmFxUK+EJ4WlQjLKiTV
lRJxuai0mM/jsumgJZ1KIiXExaXMvkfQCiCxMVksDp9XKCotLYIOCa3aamlj
PRQ8lZIyAaTzAkYORF5GWjI5RfxO+niu4edm0nPzoK8pEgmFIrEYHpLUVEF9
UdUol7U21UoqxWVlZcVFwoJ8ek5GFjUle/5txINSNo2WQ6cz2Dx+SVlJRaWk
pq5BWi+trm1okbXLoEBoamxqrBGLRGVCgRACLzubLnnrQvqjik9Lo6Xn0PML
eKi0qaquk0pbmuQdsuZWeZuiX9mrVMhaWxrqa6vEopKSQiGXlU9n3n2DsD7C
zkhKTqGlZzPYAiHUjDX1Tc3oKu7sRAKUI6MDCNIB9Y6suaFOXFZaLORwisbe
QDzMpyeTyEmptCwGGxpvSXUdtP+dncrujt4BRe/AgGp8dFA1MjTQ39nd0SqX
NTRKJWKRsFj+Ru3aC10RMZGcTEnPLeAVlVXWQHXU1tWtVEFnNNSnGhmZNBom
1SrVUH+Poq1d3ixrbJJWVohKv9si/Fqcl0yITyBCS5PD4sE+oFdta+8dgg5v
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
"], "Byte", ColorSpace -> "RGB", ImageResolution -> 150, ImageSize -> {32, 32}, Interleaving -> False];


$psi4PNG=Image[Image[CompressedData["
1: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
AgICAgICAs/D/wNSfewF
"], "Byte", ColorSpace -> "RGB", ImageSize -> {40.68359375, Automatic}, Interleaving -> True],ImageSize->32];


$psi4InIcon=
	With[{bg=GrayLevel@.9,bd=GrayLevel@.8,X=1.15,ys=.25},
	Graphics[{
		bg,
		EdgeForm@bd,
		Polygon@{{X/2,1},{X,.5},{X/2,0},{X/2,ys},{0,ys},{0,1-ys},{X/2,1-ys}},
		Inset[$psi4PNG,{0,0},{0,0},{X-.1,1}]
		},
		PlotRange->{{0,X+.05},{0,1}},
		ImageSize->32
		]
		];


$psi4OutIcon=
	With[{bg=GrayLevel@.9,bd=GrayLevel@.8,X=1.15,ys=.25},
	Graphics[{
		bg,
		EdgeForm@bd,
		Polygon@{{X/2,1},{0,.5},{X/2,0},{X/2,ys},{X,ys},{X,1-ys},{X/2,1-ys}},
		Inset[$psi4PNG,{0,0},{0,0},{X-.1,1}]
		},
		PlotRange->{{0,X+.05},{0,1}},
		ImageSize->32
		]
		];


sysOpen[f_]:=
	Switch[$OperatingSystem,
		"MacOSX",
			With[{r=
				RunProcess[{"open","-a","TextWrangler",f}]},
				If[r["ExitCode"]=!=0,
					RunProcess[{"open","-t",f}]
					]
				],
		"Windows",
			RunProcess[{"start",f}]
		];


openTMP[f_,s_]:=
	With[{opf=
		With[{tmp=OpenWrite@FileNameJoin@{$TemporaryDirectory,f}},
			WriteString[tmp,s];
			Close@tmp
			]},
		sysOpen@opf;
		RunScheduledTask[DeleteFile@opf,{1,1}]
		];


Format[Psi4[dir_?psi4Q]]:=
	RawBoxes@BoxForm`ArrangeSummaryBox[
		"Psi4",
		Psi4[dir],
		$psi4PNG,
		{
			BoxForm`MakeSummaryItem[{
				"Directory: ",
				Button[
					Mouseover[
						Style[FileNameTake@dir,"Hyperlink"],
						Style[FileNameTake@dir,"HyperlinkActive"]
						],
					SystemOpen@ExpandFileName@dir,
					Appearance->"Frameless",
					BaseStyle->"Hyperlink"
					]},
				StandardForm]
			},
		{
			BoxForm`MakeSummaryItem[{
				"Program: ",
				Button[
					Mouseover[
						Style["psi4","Hyperlink"],
						Style["psi4","HyperlinkActive"]
						],
					SystemOpen@ExpandFileName@FileNameJoin@{dir,"bin"},
					Appearance->"Frameless",
					BaseStyle->"Hyperlink"
					]
				},
				StandardForm]
			},
		StandardForm
		];


Format[Psi4Data[a_Association]]:=
	RawBoxes@BoxForm`ArrangeSummaryBox[
		"Psi4Data",
		Psi4Data[a],
		$psi4Icon,
		{
			BoxForm`MakeSummaryItem[{"Items: ",Length@a},StandardForm]
			},
		{ 
			BoxForm`MakeSummaryItem[{"Keys: ",Keys@a},StandardForm],
			BoxForm`MakeSummaryItem[{"Iterations: ",Max@(Length/@a)},StandardForm]
			},
		StandardForm
		];


Format[Psi4Input[a_Association]]:=
	RawBoxes@BoxForm`ArrangeSummaryBox[
		"Psi4Input",
		Psi4Input[a],
		$psi4InIcon,
		{
			BoxForm`MakeSummaryItem[{"Main: ",
				With[{t=a["Input","input.dat"]},
					Button[Mouseover["input.dat",Style["input.dat","HyperlinkActive"]],
						openTMP["input.dat",t],
						BaseStyle->"Hyperlink",
						Appearance->"Frameless"
						]
					]},
				StandardForm]
			},
		{
			Replace[a["Directory"],
				{
					s_String?DirectoryQ:>
						BoxForm`MakeSummaryItem[{"Directory: ",
							Button[Mouseover[FileNameTake@s,Style[FileNameTake@s,"HyperlinkActive"]],
								SystemOpen@s,
								BaseStyle->"Hyperlink",
								Appearance->"Frameless"
								]},
							StandardForm],
					_->Nothing
					}],
			With[{o=KeyDrop[a["Input"],"input.dat"]},
				If[Length@o>0,
					BoxForm`MakeSummaryItem[{
						"Other Inputs:"
						Replace[Normal@o,
							(f_->t_):>
								Button[Mouseover["input.dat",Style["input.dat","HyperlinkActive"]],
									openTMP[f,t],
									BaseStyle->"Hyperlink",
									Appearance->"Frameless"
									],
							1]
						},
						StandardForm],
					Nothing
					]
				],
			BoxForm`MakeSummaryItem[{"Output Files:",Lookup[a,"Output","output.dat"]},
				StandardForm]
			},
		StandardForm
		]


Format[Psi4Output[a_Association]]:=
	RawBoxes@BoxForm`ArrangeSummaryBox[
		"Psi4Output",
		Psi4Output[a],
		$psi4OutIcon,
		{
			BoxForm`MakeSummaryItem[{"Exit code: ",a["ExitCode"]},StandardForm]
			},
		{
			If[StringLength@a["StandardOutput"]>0,
				Button[Mouseover["Output Messages",Style["Output Messages","HyperlinkActive"]],
					CreateDialog[
						Framed[
							Pane[a["StandardOutput"],{Automatic,{150,500}},Scrollbars->Automatic],
							Background->White
							],
						Deployed->False,
						Selectable->True,
						WindowClickSelect->True,
						WindowTitle->"Standard Output"
						],
					BaseStyle->"Hyperlink",
					Appearance->"Frameless"
					],
				Nothing
				],
			If[StringLength@a["StandardError"]>0,
				Button[Mouseover["Error Messages",Style["Error Messages","HyperlinkActive"]],
					CreateDialog[
						Framed[
							Pane[a["StandardError"],{Automatic,{150,500}},Scrollbars->Automatic],
							Background->White
							],
						Deployed->False,
						Selectable->True,
						WindowClickSelect->True,
						WindowTitle->"Standard Error"
						],
					BaseStyle->"Hyperlink",
					Appearance->"Frameless"
					],
				Nothing
				],
			If[KeyMemberQ[a,"InputFiles"],
				BoxForm`MakeSummaryItem[{
					"Input files:",
					Column@
						Replace[Normal@a["InputFiles"],
							{
								(f_->t_):>
									Button[Mouseover[f,Style[f,"HyperlinkActive"]],
										openTMP[f,t],
										BaseStyle->"Hyperlink",
										Appearance->"Frameless"
										],
								f_:>
									Button[
										Mouseover[FileNameTake@f,Style[FileNameTake@f,"HyperlinkActive"]],
										sysOpen@f,
										BaseStyle->"Hyperlink",
										Appearance->"Frameless"
										]
								},
							1]
						},
						StandardForm
						],
					Nothing
					],
			If[KeyMemberQ[a,"OutputFiles"],
				BoxForm`MakeSummaryItem[{
					"Output files:",
					Column@
						Replace[Normal@Lookup[a,"OutputFiles",<||>],
							{
								(f_->t_):>
									Button[Mouseover[f,Style[f,"HyperlinkActive"]],
										openTMP[f,t],
										BaseStyle->"Hyperlink",
										Appearance->"Frameless"
										],
								f_:>
									Button[
										Mouseover[FileNameTake@f,Style[FileNameTake@f,"HyperlinkActive"]],
										sysOpen@f,
										BaseStyle->"Hyperlink",
										Appearance->"Frameless"
										]
								},
							1]
						},
						StandardForm
						],
					Nothing
					]
			},
		StandardForm
		];


Psi4/:HoldPattern[Directory@Psi4[d_?psi4Q]]:=d;


Psi4Data/:HoldPattern[Psi4Data[a_Association][p__]]:=
	psi4DataLookup[a,p]


Psi4/:HoldPattern[Psi4[d_?psi4Q][data:_String?FileExistsQ|_Association,params___]]:=
	Psi4Call[Psi4[d],data,params];
Psi4/:HoldPattern[Psi4[d_?psi4Q][Psi4Input[data_Association,params___]]]:=
	Psi4[d][data,params];


Psi4Output/:HoldPattern[Psi4Output[a_Association][k_String]]:=
	Lookup[a,k,
		Replace[
			Lookup[Lookup[a,"OutputFiles",<||>],k],
			_Missing:>Lookup[Lookup[a,"InputFiles",<||>],k]
			]
		];
Psi4Output/:HoldPattern[Psi4Output[a_Association][main_String,sub__String]]:=
	Fold[Replace[#,_List|_Association:>Lookup[#,#2]]&,a,{main,sub}];
Psi4Output/:HoldPattern[Psi4Output[a_Association][keys:{__}]]:=
	Psi4Output[a]/@keys;


Psi4Input/:HoldPattern[Psi4Input[a_Association][k_String]]:=
	Lookup[a,k,
		Lookup[a["Input"],k]
		];
Psi4Input/:HoldPattern[Psi4Input[a_Association][main_String,sub__String]]:=
	Fold[Replace[#,_List|_Association:>Lookup[#,#2]]&,a,{main,sub}];
Psi4Input/:HoldPattern[Psi4Input[a_Association][keys:{__}]]:=
	Psi4Output[a]/@keys;
Psi4Input/:
	HoldPattern[Psi4InputFile@Psi4Input[a_Association]]:=
		Psi4Input[a]["input.dat"];


Psi4Call[psi4Binary_String?FileExistsQ,
	file_String?FileExistsQ,
	output:_String|_Alternatives|_StringExpression:"output.dat",
	processFunction:RunProcess|terminalRun:RunProcess]:=
	With[{d=
		If[DirectoryQ@file,
				ExpandFileName@file,
				ExpandFileName@DirectoryName@file]},
		With[{r=
			processFunction[
				If[DirectoryQ@file,"psi4",
					{"psi4",FileNameTake@file}],
				ProcessEnvironment-><|
					"PATH"->
						StringJoin@{
							ExpandFileName@FileNameTake[psi4Binary,{1,-2}],
							":",
							Environment["PATH"]
							}
					|>,
				ProcessDirectory->d
				]},
			Psi4Output@
				If[r["ExitCode"]===0,
					Merge[{r,
						<|
							"InputFiles"->(<|FileNameTake@file->ExpandFileName@file|>),
							"OutputFiles"->FileNames[output,d]
							|>
						},
						First],
					Append[r,"InputFiles"->(<|FileNameTake@file->ExpandFileName@file|>)]
					]
			]
		];


Psi4TerminalCall[psi4Binary_String?FileExistsQ,p___]:=
	Psi4TerminalCall[psi4Binary,p]


Psi4Call[Psi4[d_String?DirectoryQ],
	a___
	]:=
	Psi4Call[FileNameJoin@{d,"bin","psi4"},a];
Psi4TerminalCall[Psi4[d_String?DirectoryQ],
	a___
	]:=
	Psi4TerminalCall[FileNameJoin@{d,"bin","psi4"},a]


Psi4Call[psi4Binary_,
	a_Association?(KeyMemberQ@"Input")|Psi4Input[a_Association?(KeyMemberQ@"Input")],
	dir:_String?DirectoryQ|Automatic:Automatic
	]:=
	With[{
		inputFiles=a["Input"],
		outputPattern=
			Replace[Lookup[a,"Output","output.dat"],{
				o_Association:>Alternatives@@Keys@o,
				Except[_String|_Alternatives|_StringExpressions]:>
					"output.dat"
				}],
		postProcessing=
			Replace[Lookup[a,"Output",Identity],{
				_String|_StringExpression|_Alternatives->
					Identity,
				l:(_List|_Rule):>Association@l,
				e:Except[_Association]:>
					<|"output.dat"->e|>
				}],
		directory=
			Replace[dir,
				Automatic:>
					Replace[a["Directory"],
						Except[_String?DirectoryQ]:>
							CreateDirectory@FileNameJoin@{$TemporaryDirectory,CreateUUID["psi4-"]}
							]
						]},
		KeyValueMap[
			With[{f=OpenWrite@FileNameJoin@{directory,#}},
				WriteString[f,#2];
				Close@f
				]&,
			inputFiles];
		With[{r=Psi4Call[psi4Binary,directory,outputPattern]},
			With[{out=
				Psi4Output@ReplacePart[First@r,{
					"InputFiles"->a["Input"],
					"GeneratedFiles"->(FileNameJoin@{directory,#}&/@Keys@a["Input"]),
					"OutputFiles"->
						With[{post=
							Replace[postProcessing,{
								l:_Association|_List:>
									Replace@
										Normal@Append[
											KeyMap[_?(StringMatchQ[#])&,Association@l],
											_->Identity],
								e_:>Replace[_->e]
								}]},
							If[FileExistsQ@#,
								With[{fn=FileNameTake@#},
									fn->
										post[fn]@
											Import[#,"Text"]
									],
								Nothing]&/@r["OutputFiles"]//
								Association
							]
					}]},
				If[dir===Automatic&&!MatchQ[a["Directory"],_String?DirectoryQ],
					DeleteDirectory[directory,DeleteContents->True]];
				out
				]
			]
		];
Psi4Call[psi4Binary_,
	a_Association?(Not@*KeyMemberQ@"Input"),
	dir:_String?DirectoryQ|Automatic:Automatic
	]:=
	Psi4Call[psi4Binary,<|"Input"->a|>,dir];


$Psi4ConfigMap=<|
	"BasisSet"->"basis",
	"SCFType"->"scf_type",
	"DFTBasisSet"->"df_basis",
	"DFTSelfConsistentBasisSet"->"df_basis_scf",
	"ReturnWavefunction"->"return_wfn",
	"Properties"->"properties",
	"GridProperties"->"grid_props",
	"CubePropTasks"->"cubeprop_tasks",
	"CubePropOrbitals"->"cubeprop_orbitals"
	|>;


$Psi4ConfigChoices=<|
	"CubePropTasks"->{"orbitals","density","basis_functions","esp"}
	|>;


psi4DeCamelCase[s_]:=
	ToLowerCase@
		StringReplace[
			s/.$Psi4ConfigMap,
			e_?(LetterQ@#&&LowerCaseQ@#&)~~
				l_?(LetterQ@#&&!LowerCaseQ@#&):>(e<>"_"<>l)
			]


Psi4Compile[expr_]:=
	With[{
		e=expr/.
			(k_String->v_):>
				(psi4DeCamelCase[k]->v)
		},
		ToPython[e]
		];


psi4MolSpec[els_,mode_]:=
	PyRow[#," "]&/@Switch[mode,
		Automatic,
			If[MatchQ[els,
					{{_String,{_?NumericQ|_String,_?NumericQ|_String,_?NumericQ|_String}}..}],
				Flatten/@els,
				els
				],
		"MolTable",
			If[MatchQ[els,{
				{_String,{_?NumericQ|_String,_?NumericQ|_String,_?NumericQ|_String}
				}..}],
				Flatten/@els,
				Flatten/@ChemUtilsGenerateMolTable@els
				],
		"ZMatrix",
			If[MatchQ[els,{{_String,{_?NumericQ,_?NumericQ,_?NumericQ}}..}],
				ChemUtilsGenerateZMatrix@els,
				Flatten/@els
				]
		]/.{"Invisible"->"X"};


$Psi4MolSpecs={
	1->"mol",
	2->"dimer",
	3->"trimer",
	4->"tetramer",
	s_String:>s,
	_->""
	};


atomCoordPat=_?NumericQ|_String|_Slot;
molBasePattern=
	{{_String,{Repeated[atomCoordPat,{3}]}}..}|
		{{_String,(atomCoordPat)...},{_String,atomCoordPat..}...};


molBlockPattern=
	{
		molBasePattern..
		};


molPattern=
	molBlockPattern|_String->molBlockPattern;


Psi4Molecule//Clear


Psi4Molecule[
	name:_String|Automatic:Automatic,
	els:molBlockPattern,
	mode:"MolTable"|"ZMatrix"|Automatic:Automatic,
	ops___String]:=
	PyBlock["molecule "<>Replace[name,Automatic:>(Length@els/.$Psi4MolSpecs)]<>" {"][
		Flatten@{
			Riffle[
				psi4MolSpec[#,mode]&/@
					ReplaceAll[els,Slot[n_]:>"pyVar_"<>ToString[n]]
					,
				"--"
				],
			ops,
			"}"
			}
		];
Psi4Molecule[
	els:molBasePattern,
	mode:"MolTable"|"ZMatrix"|Automatic:Automatic,
	ops___String]:=
	Psi4Molecule[{els},mode,ops];
Psi4Molecule[
	els:(_String->molBasePattern),
	mode:"MolTable"|"ZMatrix"|Automatic:Automatic,
	ops___String]:=
	Psi4Molecule[First[els]->{Last@els},mode,ops];
Psi4Molecule[
	mol:molPattern,
	mode:"MolTable"|"ZMatrix"|Automatic:Automatic,
	ops___String
	]:=
	If[!ListQ@mol,
		Psi4Molecule[mol[[1]],mol[[2]],mode,ops],
		Psi4Molecule[Automatic,mol,mode,ops]
		];


$psi4ConfigBlockHeader="";
$psi4ConfigBlockRiffle=" ";
$Psi4ConfigBlockHeader=Automatic;
$Psi4ConfigBlockRiffle=Automatic;
Psi4Config[props_List]:=
	With[{ps=
		Replace[props,
			(k_String->v_):>
				PyRow[{psi4DeCamelCase[k],v},
					Replace[$Psi4ConfigBlockRiffle,Automatic:>$psi4ConfigBlockRiffle]
					],
			1
			]
		},
		Which[
			Length@Flatten@props>1,
				PyBlock["set "<>
					Replace[$Psi4ConfigBlockHeader,
						Automatic:>$psi4ConfigBlockHeader
						]<>" {"][
					Append[ps,"}"]
					],
			Length@Flatten@props>0,
				PyRow[
					Flatten@{
						"set "<>
							Replace[$Psi4ConfigBlockHeader,
								Automatic:>$psi4ConfigBlockHeader
								]<>" {",
						ps,
						"}"},
					" "
					],
			True,
				Nothing
			]
		];
Psi4Config[a_Association]:=
	Psi4Config@Normal@a;
Psi4Config[r_Rule]:=
	If[MatchQ[r,_->(_?OptionQ)],
		Block[{
			$Psi4ConfigBlockHeader=
				Replace[$Psi4ConfigBlockHeader,
					Automatic:>psi4DeCamelCase[First@r/.$Psi4GeometryParametersMap]
					],
			$Psi4ConfigBlockRiffle=
				Replace[$Psi4ConfigBlockRiffle, Automatic:>""]
			},
			Psi4Config[Last@r]
			],
		Psi4Config@{r}
		];


Options@Psi4Function=
	{
		"Call"->"Required",
		"Arguments"->{},
		"KeyWordArguments"->{},
		"AssignTo"->None
		};
Psi4Function//Clear;
Psi4Function[a_Association]:=
	With[{ops=Options@Psi4Function},
		With[{components=
			Merge[{KeySelect[a,KeyMemberQ[ops,#]&],ops},First]},
			If[KeyMemberQ[components,"Function"],
				Psi4Function[components["Function"]],
				With[{
					function=components["Call"],
					args=components["Arguments"],
					kwargs=components["KeyWordArguments"],
					assignment=components["AssignTo"]
					},
					If[assignment===None,
						Identity,
						PyAssign[assignment,#]&
						][
						PyCall[function]@@
							Replace[Flatten@{args,kwargs},{
								s_String:>PyString[s],
								(k_->s_String):>
									k->PyString[s]
								},
								1]
							]
					]
				]
			]
		];
Psi4Function[r:{(_Rule|_RuleDelayed)..}]:=
	Psi4Function@Association@r;
Psi4Function[s_String][args___]:=
	Psi4Function[<|
		"Call"->s,
		"Arguments"->
			Cases[{args},Except[_Rule|_RuleDelayed]],
		"KeyWordArguments"->
			Cases[{args},_Rule|_RuleDelayed]
		|>];
HoldPattern[Psi4Function[a_->s_String][args___]]:=
	Psi4Function[<|
		"AssignTo"->a,
		"Call"->s,
		"Arguments"->
			Cases[{args},Except[_Rule|_RuleDelayed]],
		"KeyWordArguments"->
			Cases[{args},_Rule|_RuleDelayed]
		|>];


Psi4GridFile[grid_List]:=
	StringJoin@
		Riffle[
			Riffle[
				Psi4Compile/@
					Replace[#,{v_,_}:>v,1]," "]&/@(1.grid),
			"\n"];


Psi4InputFile::typerr=
	"Expected Head `` for parameter ``";


Psi4InputFile::nomol=
	"No molecules provided";
Psi4InputFile::molfmt=
	"Couldn't format molecules ``";
Psi4InputFile::nostr=
	"Arguments `` are not strings";


Psi4InputFile//Clear;
Options[Psi4InputFile]=
	{
		"Header"->None,
		"MolHeader"->None,
		"Molecules"->{},
		"MoleculeOptions"->{},
		"MolFooter"->None,
		"ConfigHeader"->None,
		"Configuration"-><||>,
		"ConfigFooter"->None,
		"FunctionHeader"->None,
		"Function"-><||>,
		"FunctionFooter"->None,
		"Footer"->None,
		"BlockSeparator"->("\n")
		};
Psi4InputFile[
	a_Association?(
		KeyMemberQ[#,"Molecules"]
			&&(
			KeyMemberQ[#,"Function"]||
			KeyMemberQ[#,"Call"]
			)&)]:=
	With[{ops=Association@Join[Options@Psi4InputFile,Options@Psi4Function]},
	With[{components=Merge[{KeySelect[a,KeyMemberQ[ops,#]&],ops},First]},
		With[{
			header=components["Header"],
			molHead=components["MolHeader"],
			mols=components["Molecules"],molKw=components["MoleculeOptions"],
			molFoot=components["MolFooter"],
			confHead=components["ConfigHeader"],
			conf=components["Configuration"],
			confFoot=components["ConfigFooter"],
			funcHead=components["FunctionHeader"],
			func=components["Function"],
			funcFoot=components["FunctionFooter"],
			footer=components["Footer"],
			sep=ToString@components["BlockSeparator"]<>"\n"
			},
			Psi4Compile@PyColumn@
				Replace[
					{
						header,
						molHead,
						Replace[mols,{
							{}:>(
								Message[Psi4InputFile::nomol,mols];
								$Failed
								),
							m:(_->_List)|{{_String,___},___}|{{{_String,___},___},___}:>
								Psi4Molecule[m,Sequence@@Normal@molKw],
							None->Nothing
							}],
						molFoot,
						confHead,
						Replace[conf,{
							(_Association|_Rule|_RuleDelayed|{__Rule}):>
								Psi4Config@conf,
							{}|None|Nothing->Nothing
							}],
						confFoot,
						funcHead,
						Replace[func,{
							_String?(StringMatchQ[(WordCharacter|"_")..]):>
								Psi4Function@
									Merge[{
										"Call"->func,
										FilterRules[components,Options@Psi4Function]
										},
										First],
							_Association|_Rule|_RuleDelayed|{__Rule}:>
								Psi4Function@
									Merge[{
										func,
										FilterRules[components,Options@Psi4Function]
										},
										First],
							{}->
								Nothing
							}],
						funcFoot,
						footer
						},
					""|None->Nothing,
					1
					]
		]
	]
	];
Psi4InputFile[r:({(_Rule|_RuleDelayed)..}|_Rule|_RuleDelayed)]:=
	Psi4InputFile@Association@r;
Psi4InputFile[r:(_Rule|_RuleDelayed)..]:=
	Psi4InputFile@<|r|>;


Psi4InputFile[
	h:_String|None:"Psi4 input.dat file",
	mh:_String|None:None,
	m:
		(_->({{_String,___},___}|{{{_String,___},___},___}))|
		{{_String,___},___}|{{{_String,___},___},___}|_String|
		_?SymbolicPythonQ,
	ch:_String|None:None,
	c:{___Rule}|_Association|_String|_?SymbolicPythonQ,
	fh:_String|None:None,
	f:{__Rule}|_Association|_String|_?SymbolicPythonQ,
	ft:_String|None:"Configured with the ChemTools suite for Mathematica",
	ops:OptionsPattern[]
	]:=
	Psi4InputFile[
		"Header"->
			Replace[h,
				s_String:>
					PyColumn[PyComment/@StringSplit[s,"\n"]]
				],
		"MolHeader"->mh,
		"Molecules"->m,
		"ConfigHeader"->ch,
		"Configuration"->c,
		"FunctionHeader"->fh,
		"Function"->f,
		"Footer"->
			Replace[ft,
				s_String:>
					PyColumn[PyComment/@StringSplit[s,"\n"]]
				],
		ops
		];


Options[Psi4ConfigureCall]=
	Normal@Merge[{
		Options@Psi4InputFile,
		<|
			"InputString"->None,
			"Input"-><||>,
			"Output"->"output.dat",
			"Directory"->Automatic
			|>
		},
		Last];
Psi4ConfigureCall[a_Association]:=
	With[{ops=Join[Options@Psi4ConfigureCall]},
		With[{components=Merge[{a,ops},First]},
			Replace[
				Replace[
					components["InputString"],
					None:>
						Psi4InputFile@
							FilterRules[components,
								Join[Options@Psi4InputFile,Options@Psi4Function]
								]
					],
				inp_String:>
					Psi4Input@
						<|
							"Input"->
								Merge[{
									components["Input"],
									<|"input.dat"->inp|>
									},
									First
									],
							"Output"->components["Output"],
							Replace[components["Directory"],{
								Except[_String?DirectoryQ]->Nothing,
								e_:>"Directory"->e
								}]
							|>
					]
			]
		];
Psi4ConfigureCall[r:({(_Rule|_RuleDelayed)..}|_Rule|_RuleDelayed)]:=
	Psi4ConfigureCall@Association@r;
Psi4ConfigureCall[r:(_Rule|_RuleDelayed)..]:=
	Psi4ConfigureCall@Association[r];
Psi4ConfigureCall[s_String,r:(_Rule|_RuleDelayed)..]:=
	Psi4ConfigureCall["InputString"->s,r];
Psi4ConfigureCall[
	h:_String|None:"Psi4 input.dat file",
	mh:_String|None:None,
	m:(_->({{_String,___},___}|{{{_String,___},___},___}))|
		{{_String,___},___}|{{{_String,___},___},___}|_String|
		_?SymbolicPythonQ,
	ch:_String|None:None,
	c:{___Rule}|_Association|_String|_?SymbolicPythonQ,
	fh:_String|None:None,
	f:{__Rule}|_Association|_String|_?SymbolicPythonQ,
	ft:_String|None:"Configured with the ChemTools suite for Mathematica",
	ops:(_Rule|_RuleDelayed)..
	]:=
	Psi4ConfigureCall[
		ops,
		"Header"->
			Replace[h,
				s_String:>
					PyColumn[PyComment/@StringSplit[s,"\n"]]
				],
		"MolHeader"->mh,
		"Molecules"->m,
		"ConfigHeader"->ch,
		"Configuration"->c,
		"FunctionHeader"->fh,
		"Function"->f,
		"Footer"->
			Replace[ft,
				s_String:>
					PyColumn[PyComment/@StringSplit[s,"\n"]]
				]
		];


$Psi4GeometryParametersMap=<|
	"OptimizationType"->"opt_type",
	"StepType"->"step_type",
	"MaxIterations"->"geom_maxiter",
	"ConvergenceCriterion"->"g_convergence",
	"HessianComputationInterval"->"full_hess_every",
	"InternalCoordinatesOnly"->"intcos_generate_exit",
	"OptimizationParameters"->"optking"
	|>;


psi4AtomArgToNum[mList_,a_]:=
	Which[
		a<0,
			Length[mList]+a,
		MatchQ[a,_String],
			First@
				FirstPosition[mList,{a,__},$Failed,{1}][[1]],
		MatchQ[a,{_String,_}],
			First@
				Position[mList,{a[[1]],__},{1}][[a[[2]]]],
		True,
			a
		]


psi4GeometryFrozenSettingPrep[l_]:=
	ToPython@PyCall[PyDot[PyString@"\\n","join"]][l]


(* Formats the frozen_cartesian argument to set optking *)
psi4GeometryFrozenPositions[
	mList_,
	positions_
	]:=
	psi4GeometryFrozenSettingPrep@
		Replace[positions,{
			(m_->l_):>
				"'`` ``'"~TemplateApply~{
					StringPadLeft[ToString@psi4AtomArgToNum[mList,m],3],
					StringJoin@
						Map[ToPython,
							Replace[Flatten@{l},{"X"|1->"x", "Y"|2->"y","Z"|3->"z"},1]
							]
					},
			_->Nothing
			},
			1
			]


(* Formats the frozen_distance argument to set optking *)
psi4GeometryFrozenDistances[
	mList_,
	dists_
	]:=
	psi4GeometryFrozenSettingPrep@
		Replace[dists,{
			(m:{_,_}->l_):>
				If[!NumericQ@l,
					"'`` `` '+ str(``)"~TemplateApply~
						Append[
							Map[StringPadLeft[ToString@psi4AtomArgToNum[mList, #],3]&,m],
							ToPython@l
							],
					"'`` `` ``'"~TemplateApply~
						Append[
							Map[StringPadLeft[ToString@psi4AtomArgToNum[mList, #],3]&,m],
							ToPython@l
							]
					],
			_->Nothing
			},
			1
			]


(* Formats the frozen_bend argument to set optking *)
psi4GeometryFrozenAngles[
	mList_,
	angs_
	]:=
	psi4GeometryFrozenSettingPrep@
		Replace[angs,{
			(m:{_,_,_}->l_):>
				If[!NumericQ@l,
					"'`` `` `` '+ str(``)"~TemplateApply~
						Append[
							Map[StringPadLeft[ToString@psi4AtomArgToNum[mList, #],3]&,m],
							ToPython@l
							],
					"'`` `` `` ``'"~TemplateApply~
						Append[
							Map[StringPadLeft[ToString@psi4AtomArgToNum[mList, #],3]&,m],
							ToPython@l
							]
					],
			_->Nothing
			},
			1
			]


(* Formats the frozen_dihedral argument to set optking *)
psi4GeometryFrozenDihedrals[
	mList_,
	diheds_
	]:=
	psi4GeometryFrozenSettingPrep@
		Replace[diheds,{
			(m:{_,_,_,_}->l_):>
				If[!NumericQ@l,
					"'`` `` `` `` '+ str(``)"~TemplateApply~
						Append[
							Map[StringPadLeft[ToString@psi4AtomArgToNum[mList, #],3]&,m],
							ToPython@l
							],
					"'`` `` `` `` ``'"~TemplateApply~
						Append[
							Map[StringPadLeft[ToString@psi4AtomArgToNum[mList, #],3]&,m],
							ToPython@l
							]
					],
			_->Nothing
			},
			1
			]


psi4GeometryFrozenPrepString[s_]:=
	s


psi4GeometryFrozenParams[mList_,params_List]:=
	With[{ms=First/@mList},
		KeyValueMap[
			Switch[#,
				1,
					"frozen_cartesian"->
						psi4GeometryFrozenPrepString@
							psi4GeometryFrozenPositions[ms,#2],
				2,
					"frozen_distance"->
						psi4GeometryFrozenPrepString@
							psi4GeometryFrozenDistances[ms,#2],
				3,
					"frozen_bend"->
						psi4GeometryFrozenPrepString@
							psi4GeometryFrozenAngles[ms,#2],
				4,
					"frozen_dihedral"->
						psi4GeometryFrozenPrepString@
							psi4GeometryFrozenDihedrals[ms,#2],
				_,
					Nothing
				]&,
			GroupBy[
				Cases[params,_Rule],
				If[ListQ[#],Length[#],1]&@*First
				]
			]
		];
psi4GeometryFrozenParams[mList_,All]:=
	psi4GeometryFrozenParams[
		mList,
		#->"xyz"&/@Range@Length[mList]
		];
psi4GeometryFrozenParams[__]:=
	{}


Psi4OptKingConfig[rules_?OptionQ]:=
	PyColumn@
		Append[
			PyAssign["optking_"<>First@#,Last@#]&/@Flatten@List@rules,
			Block[{
				$Psi4ConfigBlockRiffle = " = "
				},
				Psi4Config[
					"OptimizationParameters"->
						Map[
							First@#->"optKing_"<>First@#&,
							Flatten@List@rules
							]
						]
				]
			]


Options[Psi4GeometryOptimize]=
	Normal@
		Merge[{Options@Psi4ConfigureCall,
			"Wavefunction"->"scf",
			"FrozenParameters"->{}
			},
			Last];
Psi4GeometryOptimize[a_Association]:=
	With[{defs=Merge[{a,Options@Psi4GeometryOptimize},First]},
	Psi4ConfigureCall@
		Merge[{
			"Output"->
				Psi4DataParseGeometry,
			KeySelect[a,MatchQ[Except["Wavefunction"|"Properties"|"FrozenParameters"]]],
			"Configuration"->
				KeyMap[
					Replace[$Psi4GeometryParametersMap],
					Merge[{
						Lookup[a,"Configuration",<||>],
						"BasisSet"->"dz"
						},
						First
						]
					],
			With[{opts=
				Join[
					Flatten@List@
						Lookup[Lookup[a,"Configuration",<||>],"OptimizationParameters",{}],
					psi4GeometryFrozenParams[
						Lookup[a,"Molecules"],
						Lookup[a,"FrozenParameters"]
						]
					]
				},
				If[Length[opts]>0,
					"ConfigFooter"->
						Psi4OptKingConfig[opts],
					Nothing
					]
				],
			"Function"->
				Merge[{
					Replace[Lookup[a,"Function",<||>],p_String:>("Call"->p)],
					"Call"->"optimize",
					"Arguments"->
						Flatten@{defs["Wavefunction"]}
					},
					First]
			},
			Last]
		];


Psi4GeometryOptimize[atoms_List,props___]:=
	Psi4GeometryOptimize@
		<|
			"Molecules"->{atoms},
			props
			|>;


Options[Psi4GeometryInfo]=Options[Psi4GeometryOptimize];
Psi4GeometryInfo[a_Association]:=
	Psi4GeometryOptimize@
		Merge[{
			a,
			"Configuration"->
				<|"InternalCoordinatesOnly"->True|>,
			"Output"->
				First@*Psi4DataParseGeometry
			},
			Last
			];
Psi4GeometryInfo[atoms_List,props___]:=
	Psi4GeometryInfo@
		<|
			"Molecules"->{atoms},
			props
			|>;


Options[Psi4Energy]=
	Normal@
		Merge[{
			Options@Psi4ConfigureCall,
			"Wavefunction"->"scf",
			"FrozenParameters"->{}
			},
			Last
			];
Psi4Energy[a_Association]:=
	With[{defs=Merge[{a,Options@Psi4GeometryOptimize},First]},
	Psi4ConfigureCall@
		Merge[{
			"Output"->
				Psi4DataParseGeometry,
			KeySelect[a,MatchQ[Except["Wavefunction"|"Properties"|"FrozenParameters"]]],
			"Configuration"->
				KeyMap[
					Replace[$Psi4GeometryParametersMap],
					Merge[{
						Lookup[a,"Configuration",<||>],
						"BasisSet"->"dz"
						},
						First
						]
					],
			With[{opts=
				Join[
					Flatten@List@
						Lookup[Lookup[a,"Configuration",<||>],"OptimizationParameters",{}],
					psi4GeometryFrozenParams[
						Lookup[a,"Molecules"],
						Lookup[a,"FrozenParameters"]
						]
					]
				},
				If[Length[opts]>0,
					"ConfigFooter"->
						Psi4OptKingConfig[opts],
					Nothing
					]
				],
			"Function"->
				Merge[{
					Replace[Lookup[a,"Function",<||>],p_String:>("Call"->p)],
					"Call"->"energy",
					"Arguments"->
						Flatten@{defs["Wavefunction"]}
					},
					First]
			},
			Last]
		];


Psi4Energy[atoms_List,props___]:=
	Psi4Energy@
		<|
			"Molecules"->{atoms},
			props
			|>;


Psi4EnergyScan//Clear


Options[Psi4EnergyScan]=
	Normal@
		Merge[{
			Options@Psi4Scan,
			"Wavefunction"->"scf",
			"FrozenParameters"->{}
			},
			Last
			];
Psi4EnergyScan[a_Association]:=
	With[{defs=Merge[{a,Options@Psi4EnergyScan},First]},
	Psi4Scan@
		Merge[{
			"Output"->
				Psi4DataParseGeometry,
			KeySelect[a,MatchQ[Except["Wavefunction"|"Properties"]]],
			With[{opts=
				Join[
					Flatten@List@
						Lookup[Lookup[a,"Configuration",<||>],"OptimizationParameters",{}],
					psi4GeometryFrozenParams[
						Lookup[a,"Molecules"],
						Lookup[a,"FrozenParameters"]/.
							Slot[n_]:>"pyVar_"<>ToString[n]
						]
					]
				},
				If[Length[opts]>0,
					"ScanPre"->
						Psi4OptKingConfig[opts],
					Nothing
					]
				],
			"Configuration"->
				KeyMap[
					Replace[$Psi4GeometryParametersMap],
					Merge[{
						Lookup[a,"Configuration",<||>],
						"BasisSet"->"dz"
						},
						First
						]
					],
			"Function"->
				Merge[{
					Replace[Lookup[a,"Function",<||>],
						p_String:>("Call"->p)
						],
					"Call"->"energy",
					"Arguments"->
						Flatten@{defs["Wavefunction"]}
					},
					First
					]
			},
			Last]
		];
Psi4EnergyScan[atoms_List,props___?OptionQ]:=
	Psi4EnergyScan@
		<|
			"Molecules"->{atoms},
			props
			|>;
Psi4EnergyScan[
	atoms_List,
	grid:{_Integer,_Integer,_Integer}|_Integer:27,
	ops___?OptionQ
	]:=
	Psi4EnergyScan@
		Psi4AutoScan[atoms,grid,ops]


$Psi4PropertyParametersMap=<|
	"PropertiesOrigin"->"properties_origin"
	|>;


Options[Psi4Scan]=
	DeleteDuplicatesBy[First]@
		Flatten@{
			Options@Psi4ConfigureCall,
			"Scan"->None,
			"ScanCoordinatesPre"->Identity
			};
With[{varspec=_String|_Symbol|_PySymbol},
Psi4Scan[a_Association]:=
	With[{components=Merge[{a,Options@Psi4Scan},First]},
		Psi4ConfigureCall@Flatten@{
			"Molecules"->components["Molecules"]/.Slot[n_]:>"pyVar_"<>ToString[n],
			Replace[components["Scan"],{
				scan_List:>
					"Function"->
						With[{
							precoords=Lookup[components,"ScanCoordinatesPre",Identity],
							prefunc=Lookup[components,"ScanPre",None],
							molNameVars=
								Association@Flatten@
									Block[{mnameCounter=1},
										Replace[
											Replace[components["Molecules"],
												m:{{_String,_}...}|{{_String},___}:>{m}
												],
											{
												(m_->e_):>
													Thread[Cases[e,_Slot|_PyVar,\[Infinity]]->m],
												e_:>(
													Thread[
														Cases[e,_Slot|_PyVar,\[Infinity]]->
															"mol_"<>ToString[mnameCounter++]
														]
													)
												},
											1
											]
										],
							scanList=
								Block[{itVarCounter=1},
									Replace[
										Reverse@
											Replace[scan/.Slot[n_]:>"pyVar_"<>ToString[n],
												s:{varspec|{varspec..},__}:>{s}
												],
										i:Except[varspec|{varspec..}]:>
											Flatten[{"pyVar_"<>ToString[itVarCounter++],i},1],
										1
										]
									]
							},
							Fold[
								Replace[#2,{
									{i:varspec|{varspec..},s_}:>
										PyForIn[i,Replace[s,n_Integer:>PyRange[n]]][#],
									{i:varspec,s1_,s2__}:>
										PyForIn[i,PyRange[s1,s2]][#],
									_:>
										#
									}]&,
									If[Length[molNameVars]>0,
										With[{
											mnVars=
												KeyValueMap[
													PyDot[#2,
														Replace[#,
															Verbatim[Slot][n_]:>
																"pyVar_"<>ToString[n]
															]
														]&,
													molNameVars
													],
											scanVars:=
												SortBy[
													Map[First,scanList],
													Position[Last/@mnVars,#]&
													]
											},
											With[{
												pref=
													If[prefunc=!=None,
														prefunc/.{
															f_String[args___]:>
																PyCall[f][args]
															}/.Slot[n_]:>"pyVar_"<>ToString[n],
														Nothing
														],
												pf=
													If[precoords=!=Identity,
														precoords/.{
															f_String[args___]:>
																PyCall[f][args]
															}/.Slot[n_]:>"pyVar_"<>ToString[n],
														scanVars
														]
												},
												PyColumn@{
													pref,
													PyAssign[
														mnVars,
														pf
														],
													#
													}&
												]
											],
										Identity
										]@
									Replace[
										Lookup[components,"Function"]/.{
											s_String[args___]:>
												PyCall[s][args]
											}/.Slot[n_]:>"pyVar_"<>ToString[n],{
										f_Association:>
											Psi4Function@f,
										s:_?SymbolicPythonQ|_String:>
											s,
										Defer[e___]:>
											{e},
										_:>
											PyPrint@Psi4Function@components
										}],
							scanList
							]
						],
				e_:>
					Nothing	
				}],
			"Molecules"->
				Replace[Lookup[components,"Molecules",None],{
					l:(_List|_->_List):>
						(l/.Slot[n_]:>"pyVar_"<>ToString[n])
					}],
			Normal@
				KeyDrop[components,
					{
						"Molecules",
						"Scan","ScanCoordinatesPre",
						"Function","Call",
						"AssignTo","Arguments",
						"KeyWordArguments"
						}
					]
			}
		]
	];


$Psi4OneElectronParametersMap=
	<|
		"DipoleMoment"->"dipole",
		"QuadrupoleMoment"->"quadrupole",
		"MultipoleMoment"->"multipole",
		"NucleiElectrostaticPotential"->"esp_at_nuclei",
		"ElectrostaticPotential"->"grid_esp",
		"ElectricField"->"grid_field",
		"OrbitalExtents"->"mo_extents",
		"MullikenCharges"->"mulliken_charges",
		"LoewdinCharges"->"lowdin_charges",
		"WidbergIndices"->"widberg_lowdin_charges",
		"MayerIndices"->"mayer_indices",
		"OrbitalOccupations"->"no_occupations"
		|>;


Options@Psi4OneElectronProperty=
	Normal@
		Merge[{Options@Psi4ConfigureCall,
			"Wavefunction"->"scf",
			"Properties"->{}
			},
			Last];
Psi4OneElectronProperty[a_Association]:=
	With[{defs=Merge[{a,Options@Psi4OneElectronProperty},First]},
	Psi4ConfigureCall@
		Merge[{
			KeySelect[a,MatchQ[Except["Wavefunction"|"Properties"]]],
			"Configuration"->
				Merge[{
					Lookup[a,"Configuration",<||>],
					<|"BasisSet"->"cc-pvdz"|>
					},
					First],
			"Function"->
				Merge[{
					"KeyWordArguments"->
						Normal@Merge[{
							Lookup[a,"KeyWordArguments",{}],
							"Properties"->
								Map[
									Lookup[$Psi4OneElectronParametersMap,#,#]&,
									Flatten@{defs["Properties"]}
									]
							},
							Apply@Join
							],
					Replace[Lookup[a,"Function",<||>],p_String:>("Call"->p)],
					"Call"->"property",
					"Arguments"->
						Flatten@{defs["Wavefunction"]}
					},
					First]
			},
			Last]
		];
Psi4OneElectronProperty[r:({(_Rule|_RuleDelayed)..}|(_Rule|_RuleDelayed)..)]:=
	Psi4OneElectronProperty@Association@r;


Psi4OneElectronProperty[atoms_List,
	grid:_List|Automatic:
	props___?OptionQ]:=
	Psi4OneElectronProperty@
		<|
			"Molecules"->{atoms},
			props
			|>;


Options[Psi4OneElectronElectrostaticPotential]=
	Append[Options@Psi4OneElectronProperty,"Grid"->None];
Psi4OneElectronElectrostaticPotential[a_Association]:=	
	Psi4OneElectronProperty@Merge[{
		<|
			"Header"->
				"#"<>DateString@Now<>"\n"<>
					"#Grid electrostatic potential calculation",
			"MoleculeOptions"->{"noreorient","nocom"},
			"Arguments"->{"scf"},
			"Properties"->{"GRID_ESP","GRID_FIELD"},
			"Output"->"grid_esp.dat"|"grid_field.dat"
			|>,
		a},
		First];
Psi4OneElectronElectrostaticPotential[
	r:({(_Rule|_RuleDelayed)..}|(_Rule|_RuleDelayed)..)]:=
	Psi4OneElectronElectrostaticPotential@Association@r;


Psi4OneElectronElectrostaticPotential[atomset_List,a___]:=
	Psi4OneElectronElectrostaticPotential@
		Flatten[Psi4UtilsAutoGrid[atomset,a],2];


Psi4OneElectronDipoleMoment[specs__]:=
	Psi4OneElectronProperty[specs,
		"Properties"->
			"DipoleMoment",
		"Output"->
			Psi4DataParseDipoles
		];


Options[Psi4CubeProperty]=Append[Options@Psi4ConfigureCall];
Psi4CubeProperty[a_Association]:=
	Psi4ConfigureCall@Merge[{
		<|
			"MoleculeOptions"->
				Join[
					{"MolTable","noreorient","nocom"},
					Lookup[a,"MoleculeOptions",{}]
					],
			"Configuration"->
				Merge[{
					Lookup[a,"Configuration",<||>],
					<|
						"BasisSet"->"cc-pvdz",
						"SCFType"->"df",
						"CubePropTasks"->"orbitals",
						"CubePropOrbitals"->{1}
						|>
					},
					First
					],
			"Function"->
					<|
						"AssignTo"->{"E","wfn"},
						"Call"->"energy",
						"Arguments"->{"scf"},
						"KeyWordArguments"->{"ReturnWavefunction"->True}
						|>,
			"Footer"->"cubeprop(wfn)",
			If[Lookup[a,"Grid",None]===None,
				Nothing,
				"Input"->
					Merge[{a["Input"],<|"grid.dat"->Psi4GridFile@a["Grid"]|>},Last]
				]
			|>,
		a,
		<|
			"Header"->"#"<>DateString@Now<>"\n"<>
				"#Cube prop call",
			"Output"->"*.cube"|"*.xyz"
			|>
		},
		First
		];
Psi4CubeProperty[r:({(_Rule|_RuleDelayed)..}|(_Rule|_RuleDelayed)..)]:=
	Psi4CubeProperty@Association@r;


Options[Psi4CubeOrbitals]=Options@Psi4CubeProperty;
Psi4CubeOrbitals[a_Association]:=
	Psi4CubeProperty@
		Merge[{
			Append[a,
				"Configuration"->
					Merge[{Lookup[a,"Configuration",<||>],
						<|
							"CubePropTasks"->{"orbitals"},
							"CubePropOrbitals"->{1,-1,2,-2,3,-3,4,-4,5,-5}
							|>
						},
						First]
				],
			"Output"->"Psi_*.cube"
			},
			First];
Psi4CubeOrbitals[atomList_List,orbitals:{__Integer}:{1},p:(_Rule|_RuleDelayed)...]:=
	Psi4CubeOrbitals@
		<|
			"Molecules"->atomList,
			"CubePropOrbitals"->orbitals,
			p
			|>;
Psi4CubeOrbitals[atomList_List,orbitals_Integer,p:(_Rule|_RuleDelayed)...]:=
	Psi4CubeOrbitals[atomList,Join[#,-#]&@Range[orbitals]]


Psi4CubeElectronDensity[a_Association]:=
	Psi4CubeProperty@
		Merge[{
			Append[a,
				"Configuration"->
					Merge[{Lookup[a,"Configuration",<||>],
						<|
							"CubePropTasks"->{"density"},
							"CubePropOrbitals"->{1}
							|>
						},
						First]
				],
			"Output"->"Dt.cube"|"Ds.cube"|"Da.cube"|"Db.cube"
			},
			First];
Psi4CubeElectronDensity[atomList_List,p___]:=
	Psi4CubeElectronDensity@
		<|
			"Molecules"->atomList,
			p
			|>;


Psi4CubeElectrostaticPotential[a_Association]:=
	Psi4CubeProperty@
		Merge[{
			"Configuration"->
				Merge[{
					Lookup[a,"Configuration",<||>],
						<|
							"CubePropTasks"->{"esp"},
							"CubePropOrbitals"->{1},
							"DFTSelfConsistentBasisSet"->"cc-pvdz-jkfit",
							"FreezeCore"->True
							|>
						},
					First
					],
				a,
				"Output"->"Dt.cube"|"ESP.cube"
				},
				First];
Psi4CubeElectrostaticPotential[atomList_List,p___]:=
	Psi4CubeElectrostaticPotential@
		<|
			"Molecules"->atomList,
			p
			|>;


zmatrix1=
	(Whitespace~~LetterCharacter..~~(Whitespace|EndOfLine));
zmatrix2=
	(Whitespace~~LetterCharacter..~~Whitespace~~
		(DigitCharacter..)~~Whitespace~~NumberString~~(Whitespace|EndOfLine));
zmatrix3=
	(Whitespace~~LetterCharacter..~~Whitespace~~
		(DigitCharacter..)~~Whitespace~~NumberString~~Whitespace~~
		(DigitCharacter..)~~Whitespace~~NumberString~~(Whitespace|EndOfLine));
zmatrix4=
	(Whitespace~~LetterCharacter..~~Whitespace~~
		(DigitCharacter..)~~Whitespace~~NumberString~~Whitespace~~
		(DigitCharacter..)~~Whitespace~~NumberString~~Whitespace~~
		(DigitCharacter..)~~Whitespace~~NumberString~~(Whitespace|EndOfLine));
molTable=
	Whitespace~~LetterCharacter..~~
		Whitespace~~NumberString~~
		Whitespace~~NumberString~~
		Whitespace~~NumberString;


psi4GeomTableHeader=
	StringExpression@@
		Riffle[{
			StartOfLine,
			"Center","X","Y","Z","Mass","\n",
			Sequence@@ConstantArray[Repeated["-"],4],
			(Repeated["-"]~~"\n")
			},
			Whitespace
			];
psi4GeomTableBody=
	Repeated[
		StringExpression@@
			Riffle[
				{
					"",WordCharacter..,
					Sequence@@ConstantArray[NumberString,3],
					NumberString~~"\n"
					},
				Whitespace
				]
		]


$pointGroupList=
	<|
		"c1"->{{"CrystallographicPointGroup",1}},"c2"->{{"CrystallographicPointGroup",3}},
		"c2h"->{{"CrystallographicPointGroup",5}},"c2v"->{{"CrystallographicPointGroup",7}},
		"c3"->{{"CrystallographicPointGroup",16}},"c3h"->{{"CrystallographicPointGroup",22}},
		"c3v"->{{"CrystallographicPointGroup",19}},"c4"->{{"CrystallographicPointGroup",9}},
		"c4h"->{{"CrystallographicPointGroup",11}},
		"c4v"->{{"CrystallographicPointGroup",13}},"c5"->{{"CyclicGroup",5}},"c5h"->"C5h",
		"c5v"->"C5v","c6"->{{"CrystallographicPointGroup",21}},
		"c6h"->{{"CrystallographicPointGroup",23}},
		"c6v"->{{"CrystallographicPointGroup",25}},"c7"->{{"CyclicGroup",7}},"c7v"->"C7v",
		"c8"->{{"CyclicGroup",8}},"c8v"->"C8v",
		"ci"->{{"CrystallographicPointGroup",2}},"cs"->{{"CrystallographicPointGroup",4}},
		"c\[Infinity]v"->"C\[Infinity]v","d2"->{{"CrystallographicPointGroup",6}},
		"d2d"->{{"CrystallographicPointGroup",14}},"d2h"->{{"CrystallographicPointGroup",8}},
		"d3"->{{"CrystallographicPointGroup",18}},"d3d"->{{"CrystallographicPointGroup",20}},
		"d3h"->{{"CrystallographicPointGroup",26}},"d4"->{{"CrystallographicPointGroup",12}},
		"d4d"->"D4d","d4h"->{{"CrystallographicPointGroup",15}},
		"d5"->{{"DihedralGroup",5}},"d5d"->"D5d",
		"d5h"->"D5h","d6"->{{"CrystallographicPointGroup",24}},
		"d6d"->"D6d","d6h"->{{"CrystallographicPointGroup",27}},
		"d7"->{{"DihedralGroup",7}},"d7d"->"D7d",
		"d7h"->"D7h","d8"->{{"DihedralGroup",8}},
		"d8d"->"D8d","d8h"->"D8h",
		"d\[Infinity]h"->"D\[Infinity]h","i"->"I",
		"ih"->{"Icosahedral"},"o"->{{"CrystallographicPointGroup",30}},
		"oh"->{{"CrystallographicPointGroup",32}},"s10"->{{"SymmetricGroup",10}},
		"s12"->{{"SymmetricGroup",12}},"s2"->{{"SymmetricGroup",2}},
		"s4"->{{"CrystallographicPointGroup",10}},"s6"->{{"CrystallographicPointGroup",17}},
		"s8"->{{"SymmetricGroup",8}},"t"->{{"CrystallographicPointGroup",28}},
		"td"->{{"CrystallographicPointGroup",31}},"th"->{{"CrystallographicPointGroup",29}}
		|>;


parsePointGroup[grp_]:=
	With[{s=
		ToLowerCase@
			StringReplace[grp,{
				"_inf_"->"\[Infinity]"
				}]
		},
		Replace[
			Lookup[
				$pointGroupList,
				ToLowerCase@s,
				ToUpperCase[StringTake[s,1]]<>StringDrop[s,1]
				],
			{l_}:>
				Entity["FiniteGroup",l]
			]
		]


$parseUnitList=
	{
		"a.u."->"AtomicUnitOfForce",
		"cm^-1"->(1/"Centimeters")
		}


parseUnit[u_,reps_:{}]:=
	Quantity@
		Replace[StringTrim[u,"]"|"["|")"|"("],
			Flatten@{
				reps,
				$parseUnitList
				}]


propLinePattern=
	Whitespace~~
		(
			"Molecular point group"|
			"Full point group"|
			"Rotational constants"|
			"Nuclear repulsion"|
			"Charge"|"Multiplicity"|"Electrons"|
			"Nalpha"|"Nbeta"|
			"Nuclear Repulsion Energy"|"One-Electron Energy"|
			"Two-Electron Energy"|("Total Energy"~~Whitespace~~"=")|
			(("Nuclear"|"Electronic")~~" Dipole Moment:"~~Except["\n"]..~~"\n")|
			"Setting geometry variable "
			)~~(Except["\n"]..);


parseProp[s_]:=
	Which[
		(* Point Groups *)
		StringContainsQ[s,"point group:"],
			StringTrim@First@StringSplit[s,"point group:"]<>
				"PointGroup"->
					parsePointGroup@
						First@StringCases[s,": "~~p:(Except[WhitespaceCharacter]..):>p],
		(* Rotational Constants *)
		StringContainsQ[s,"Rotational constants"],
			"RotationalConstants"->
				Association@Cases[
					StringReplace[s,{
						l_~~" ="~~Whitespace~~v:NumberString:>
							l->ToExpression@v,
						"["~~u:Except["]"]..~~"]":>
							"Units"->parseUnit[u]
						}],
					_Rule],
		(* Nuclear Repulsion *)
		StringContainsQ[s,"Nuclear repulsion"],
			"NuclearRepulsion"->
				First@StringCases[s,NumberString],
		(* Charge, Multiplicity, Electrons, N_alpha, N_beta *)
		StringContainsQ[s,"Charge"|"Multiplicity"|"Electrons"|"Nalpha"|"Nbeta"],
				First@
					StringCases[s,
						l:(LetterCharacter..)~~Whitespace~~"= "~~n:NumberString:>(l->n)],
		(* Energies *)
		StringContainsQ[s,
			"Nuclear Repulsion Energy"|"One-Electron Energy"|
			"Two-Electron Energy"|"Total Energy"~~Whitespace~~"="
			],
			First@
				StringCases[s,
					l:__~~"= "~~Whitespace~~n:NumberString:>
					(StringReplace[l,Except[WordCharacter]->""]->ToExpression[n])
					],
		(* Dipole Moments *)
		StringContainsQ[s,"Dipole Moment"],
			With[{bits=StringTrim@StringSplit[s, "Dipole Moment:"|"X:"|"Y:"|"Z:"]},
				bits[[1]]<>"DipoleMoment"->
					Append[
						AssociationThread[{"X","Y","Z"},
							ToExpression@bits[[{3,4,5}]]
							],
						"Unit"->parseUnit@bits[[2]]
						]
				],
		(* Scan variables *)
		StringContainsQ[s,"Setting geometry variable "],
			StringCases[s,
				"Setting geometry variable "~~var:Except[WhitespaceCharacter]..~~" to "~~
					val:Except[WhitespaceCharacter]..:>
					"ScanVariable"->
						(var->ToExpression[val])
				]
		]


blockDelimeters=("*** tstart()"~~Except["\n"]..)|("*** tstop()"~~Except["\n"]..);


Psi4DataParseGeometry[os_]:=
	With[{
		atomCount=
			Length@Select[
				StringSplit[First@StringCases[os,"molecule"~~Except["}"]..~~"}"],"\n"],
					StringContainsQ[#,NumberString]||
						ChemDataAtomQ@StringTrim@#&
				]
		},
	Block[{
		blockMolTable=None,
		blockZMatrix=None,
		blockGeomTable=None,
		blockProps={},
		blockMeta={},
		blockCache={},
		cacheBlockData=(
			AppendTo[
				blockCache,
				<|
					"ZMatrix"->blockZMatrix,
					"MolTable"->blockMolTable,
					"GeometryTable"->blockGeomTable,
					"Properties"->blockProps,
					"MetaInfo"->blockMeta
					|>];
				blockProps={};
				blockMeta={};
				blockZMatrix=None;
				blockMolTable=None;
				blockGeomTable=None;
				)&
		},
	
	Replace[
		StringCases[os,{
			(* Extract GeomTable *)
			psi4GeomTableHeader~~s:psi4GeomTableBody:>
				"GeometryTable"->
					Replace[
						ImportString[s,"Table"],
						{e_,x_,y_,z_,m_}:>{e,{x,y,z},m},
						1
						],
			(* Extract MolTable *)
			s:(StartOfLine~~Repeated[molTable~~EndOfLine,{atomCount}]):>
				"MolTable"->
					Replace[ImportString[StringTrim@s,"Table"],
						{e_,x_,y_,z_}:>{e,{x,y,z}},
						1
						],
			(* Extract ZMatrix *)
			s:(StartOfLine~~StringExpression@@
					Switch[atomCount,
						1,
							{zmatrix1},
						2,
							{zmatrix1,zmatrix2},
						_,
							Join[{zmatrix1,zmatrix2,zmatrix3},ConstantArray[zmatrix4,atomCount-3]]
						]):>
				"ZMatrix"->ImportString[StringTrim@s,"Table"],
			(* Extract Properties *)
			s:(StartOfLine~~propLinePattern~~EndOfLine):>
				"Property"->parseProp@s,
			(* Extract run times *)
			timeBlock:
				(
					WordCharacter..~~" time:\n"~~
					Repeated[
						Whitespace~~WordCharacter..~~" time"~~Whitespace~~"="~~Whitespace~~
						NumberString~~" seconds "~~Except["\n"]..
						]
					):>
					"MetaInfo"->(
						"RunTime"->
							With[{blocks=StringSplit[timeBlock,"\n",2]},
								Prepend["Timing"->StringTrim[blocks[[1]]," time:"]]@
								StringCases[Last@blocks,
									Whitespace~~
										sys:WordCharacter..~~" time"~~Whitespace~~"="~~Whitespace~~
											time:NumberString~~" seconds ":>
										Capitalize[sys]<>"Time"->Quantity[ToExpression[time],"Seconds"]
									]
								]
						),
			(* Block Delimiters *)
			s:(StartOfLine~~blockDelimeters~~EndOfLine):>
				Break
				}
			],
		{
			Break:>
				cacheBlockData[],
			("GeometryTable"->t_):>
				If[blockGeomTable===None,
					blockGeomTable=t,
					cacheBlockData[]
					],
			("MolTable"->t_):>
				If[blockMolTable===None,
					blockMolTable=t,
					cacheBlockData[]
					],
			("ZMatrix"->t_):>
				If[blockZMatrix===None,
					blockZMatrix=t,
					cacheBlockData[]
					],
			("Property"->p_):>
				AppendTo[blockProps,p],
			("MetaInfo"->p_):>
				AppendTo[blockMeta,p]
			},
		1];
		If[Length@blockProps>0,cacheBlockData[]];
		DeleteCases[
			blockCache,
			_Association?(
				Lookup[#,
					{"ZMatrix","MolTable","GeometryTable","Properties","MetaInfo"}
					]==={None,None,None,{},{}}&
				)
			]
		]
	];


Psi4DataParseDipoles[out_]:=
	Replace[
		With[{lines=StringSplit[out,EndOfLine]},
			With[{p=Position[lines,_String?(StringContainsQ["Dipole"])]},
				Map[lines[[#]]&,Replace[p,{i_}:>{i,i+1},1] ]
				]
			],
		{dLine_,pLine_}:>Association@*Append@@{
			Replace[StringCases[dLine,Except[WhitespaceCharacter]..],
				{dT_:"Overall","Dipole",__,dU_}:>{
					"DipoleType"->dT,
					"DipoleUnits"->
						Quantity[1,
							Evaluate@Switch[dU,
								"(a.u.)",
									"ElementaryCharge"*"BohrRadius",
								"(Debye)",
									"Debye"]
							]
					}],
			Replace[StringCases[pLine,NumberString],
				{x_,y_,z_,___}:>
					"DipoleVector"->ToExpression@{x,y,z}
				]
			},
		1]


Psi4DataLookup[data_Association,p:(_String..),its:_Integer|_List|All:All]:=
	Replace[data[p],
		l_List:>l[[its]]
		];
Psi4DataLookup[Psi4Data[a_Association],o___]:=
	Psi4DataLookup[a,o];


End[];



